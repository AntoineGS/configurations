# P0.13 VCC Cutoff Implementation - Test Log

**Date:** 2025-12-19  
**Board:** nice!nano v2  
**Feature:** Built-in P0.13 VCC cutoff circuit for external peripherals

---

## Changes Made

### 1. Devicetree (keyball44_right.overlay)

Added external power control node:

```dts
/ {
  /* External power control for trackball via P0.13 VCC cutoff */
  ext_power {
    compatible = "zmk,ext-power-generic";
    label = "EXT_POWER";
    control-gpios = <&gpio0 13 GPIO_ACTIVE_HIGH>;
    init-delay-ms = <50>;
  };
};
```

**What this does:**
- Creates an external power device controlled by GPIO P0.13
- P0.13 HIGH = VCC pins powered ON (trackball working)
- P0.13 LOW = VCC pins powered OFF (trackball off, power saved)
- 50ms delay on power-on for sensor stabilization

### 2. Configuration (keyball44_right.conf)

Already had: `CONFIG_ZMK_EXT_POWER=y` âœ…

**How it works:**
The `ext_power_generic` driver has built-in PM hooks that automatically:
- Disable VCC (P0.13 LOW) when entering deep sleep
- Enable VCC (P0.13 HIGH) when waking up

---

## How P0.13 VCC Cutoff Works

The nice!nano v2 board has an on-board load switch circuit:

```
nRF52840 P0.13 â†’ [Load Switch IC] â†’ VCC output pins (Pro Micro edge)
                                     â†“
                                   Trackball VDD
```

When ZMK enters deep sleep:
1. PM system calls `ext_power_generic_pm_action(PM_DEVICE_ACTION_SUSPEND)`
2. Driver sets P0.13 LOW
3. Load switch opens (disconnects VCC)
4. Trackball loses power â†’ 0ÂµA consumption âœ…

When ZMK wakes up:
1. PM system calls `ext_power_generic_pm_action(PM_DEVICE_ACTION_RESUME)`
2. Driver sets P0.13 HIGH  
3. Load switch closes (connects VCC)
4. Trackball powers on â†’ works normally âœ…

---

## Critical Requirement

**The trackball VDD MUST be connected to the VCC output pin controlled by P0.13.**

Check your wiring:
- âŒ WRONG: Trackball VDD â†’ nRF52840 internal 3.3V rail (bypasses load switch)
- âœ… RIGHT: Trackball VDD â†’ VCC pin on Pro Micro pinout edge (goes through load switch)

On nice!nano v2, the controlled VCC pins are typically:
- Pin labeled "VCC" or "3.3V" on the Pro Micro pinout edge
- NOT the RAW pin (that's battery voltage)
- NOT direct connection to nRF52840 VDD (that's uncontrolled)

---

## Testing Procedure

### Phase 1: Verify Hardware Connection

**Before building firmware:**

1. **Check board schematic** - Confirm which pins are controlled by P0.13 load switch
2. **Verify trackball wiring** - Ensure VDD connects to controlled VCC pin
3. **If unsure:** Trace the VCC trace from trackball back to board

### Phase 2: Build and Flash

```bash
cd ~/gits/configurations/Linux/zmk-config/keyball44
./build_flash.sh right
```

### Phase 3: Initial Power Test

**With keyboard powered on:**

1. **Test trackball works** - Move it, verify cursor moves
2. **Measure voltage at trackball VDD pin** - Should be 3.3V
3. **Check P0.13 state** - Should be HIGH (VCC enabled)

### Phase 4: Manual Control Test (Optional)

Add to keymap for testing:
```
&ext_power EP_OFF  // Turn off VCC
&ext_power EP_ON   // Turn on VCC
&ext_power EP_TOG  // Toggle VCC
```

1. **Press EP_OFF key**
2. **Trackball should stop working** (powered off)
3. **Measure voltage at trackball VDD** - Should be 0V
4. **Measure current** - Should drop
5. **Press EP_ON key**
6. **Trackball should work again** (powered on)
7. **Voltage should return to 3.3V**

### Phase 5: Deep Sleep Test

**The main test:**

1. **Connect multimeter in series with battery** (measure current)
2. **Power on keyboard**
3. **Active current:** Should be ~1.5-2.0mA (trackball working)
4. **Wait for deep sleep:** 5 seconds (configured in .conf file)
5. **Sleep current:** Should drop to **~0.20mA** âœ…
6. **Press any key to wake**
7. **Active current:** Should return to ~1.5-2.0mA
8. **Trackball should work immediately**

### Phase 6: Overnight Test

1. **Leave keyboard in deep sleep overnight**
2. **Measure current:** Should remain at ~0.20mA
3. **Wake up next day**
4. **Verify trackball works normally**
5. **Check battery level** - Should show minimal drain

---

## Expected Results

| State | P0.13 | VCC Pin | Trackball VDD | Current | Battery Life |
|-------|-------|---------|---------------|---------|--------------|
| Active | HIGH | 3.3V | 3.3V | 1.95mA | - |
| Deep Sleep | LOW | 0V | 0V | **0.20mA** âœ… | ~115 days |
| Wake | HIGH | 3.3V | 3.3V | 1.95mA | - |

**Success criteria:**
- âœ… Deep sleep current: 0.15-0.25mA
- âœ… Trackball works after wake
- âœ… No errors in logs
- âœ… Battery life: >100 days

---

## Troubleshooting

### Issue: Trackball never powers off (VDD always 3.3V)

**Symptom:** Current stays at 1.95mA in sleep, trackball VDD measures 3.3V

**Cause:** Trackball wired to wrong power source (bypassing P0.13 switch)

**Solutions:**
1. Check which pin trackball VDD is connected to
2. Trace to ensure it goes through P0.13 load switch
3. If wired to wrong rail, need to rewire OR use external MOSFET solution

### Issue: Trackball works but current still high in sleep (1.5-2.0mA)

**Symptom:** Trackball functions, but current doesn't drop in sleep

**Cause:** EXT_POWER device not being suspended by PM system

**Debug steps:**
1. Enable debug logging:
   ```
   CONFIG_LOG=y
   CONFIG_PM_DEVICE_LOG_LEVEL_DBG=y
   CONFIG_ZMK_LOG_LEVEL_DBG=y
   ```
2. Check USB logs for:
   - "ext_power" PM actions
   - "PM_DEVICE_ACTION_SUSPEND" messages
3. Verify `CONFIG_ZMK_EXT_POWER=y` is set

**Possible fixes:**
- Increase sleep timeout to ensure device actually sleeps
- Check if PM_DEVICE config conflicts

### Issue: Trackball doesn't work after wake

**Symptom:** Keyboard wakes, but trackball unresponsive

**Cause:** Sensor not initializing properly after power restored

**Solutions:**
1. Increase power-on delay:
   ```dts
   init-delay-ms = <100>;  // Was 50ms
   ```
2. PMW3610 sensor needs time to boot after power-on
3. Try 100ms, 200ms, or even 500ms if needed

### Issue: VDD voltage is unstable (not 0V or 3.3V)

**Symptom:** Voltage measures between 0V and 3.3V

**Cause:** Load switch partially enabled or high leakage

**Solutions:**
1. Check GPIO configuration (ACTIVE_HIGH vs ACTIVE_LOW)
2. Verify load switch IC is functioning
3. May indicate hardware issue with board

---

## Rollback Plan

If this doesn't work:

### Option 1: Revert Changes

```bash
cd ~/gits/configurations/Linux/zmk-config/keyball44
git checkout boards/shields/keyball44/keyball44_right.overlay
./build_flash.sh right
```

### Option 2: Use External MOSFET Solution

Follow [MOSFET_POWER_SWITCH_SOLUTION.md](./MOSFET_POWER_SWITCH_SOLUTION.md) instead.

---

## Next Steps After Testing

### If Successful (0.20mA sleep):

1. âœ… Document the success
2. âœ… Remove debug configs
3. âœ… Restore sleep timeout to normal (15 minutes):
   ```
   CONFIG_ZMK_IDLE_SLEEP_TIMEOUT=900000
   ```
4. âœ… Commit changes to git
5. âœ… Celebrate 5x battery life improvement! ðŸŽ‰

### If Failed (still high current):

1. Check hardware wiring (most common issue)
2. Review troubleshooting section above
3. Consider external MOSFET solution
4. Document findings in this file

---

## Notes

- **Sleep timeout currently set to 5 seconds** for testing (line 8 in .conf)
- **Normal timeout is 15 minutes** (900000ms)
- **Remember to change back after testing!**
- This solution requires ZERO soldering if wiring is correct
- P0.13 load switch is also used for RGB LED control on many boards

---

## Status: READY FOR TESTING

**Changes committed:** No (pending test results)  
**Next action:** Build, flash, and test sleep current  
**Expected outcome:** 0.20mA deep sleep current âœ…
