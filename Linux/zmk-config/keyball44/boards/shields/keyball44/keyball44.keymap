#define DEF 0
#define NAV 1
#define SYM 2
#define NUM 3
#define SCR 5  // Scroll mode layer (layer 5 matches overlay config)

// Timing constants for homerow mods and hold-tap behaviors
#define HRM_TAPPING_TERM 280
#define HRM_QUICK_TAP 175
#define HRM_PRIOR_IDLE 150
#define LT_TAPPING_TERM 240
#define LT_QUICK_TAP 175

/* #define HOST_OS 1 // 1 = Linux, 2 = Windows, 3 = MacOS */

// Macro helpers for French accented characters
// These reduce repetition in accent macro definitions
#define ACCENT_MACRO(dead_key, letter) \
    compatible = "zmk,behavior-macro"; \
    #binding-cells = <0>; \
    bindings = <&macro_tap &kp dead_key> \
             , <&macro_tap &kp letter>;

// Helper for homerow mod hold-tap behaviors
// Creates a hold-tap with configurable trigger positions (for left/right hand)
#define HOMEROW_MOD(trigger_positions) \
    compatible = "zmk,behavior-hold-tap"; \
    #binding-cells = <2>; \
    flavor = "balanced"; \
    tapping-term-ms = <HRM_TAPPING_TERM>; \
    quick-tap-ms = <HRM_QUICK_TAP>; \
    require-prior-idle-ms = <HRM_PRIOR_IDLE>; \
    bindings = <&kp>, <&kp>; \
    hold-trigger-key-positions = <trigger_positions>; \
    hold-trigger-on-release;

// Helper for hold-tap behaviors with French accent macros
// Takes modifier key as first parameter (for &kp) and 0 as second (accent macro ignores it)
// Usage: &egrv_hrm LGUI 0
#define ACCENT_HRM(accent_macro) \
    compatible = "zmk,behavior-hold-tap"; \
    #binding-cells = <2>; \
    flavor = "balanced"; \
    tapping-term-ms = <HRM_TAPPING_TERM>; \
    quick-tap-ms = <HRM_QUICK_TAP>; \
    require-prior-idle-ms = <HRM_PRIOR_IDLE>; \
    bindings = <&kp>, <&accent_macro>; \
    hold-trigger-key-positions = <KEYS_R THUMBS>; \
    hold-trigger-on-release;

#include <behaviors/mouse_keys.dtsi>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/mouse.h>
#include "keys_us_international.h"

// nice!view display configuration
&nice_view_spi { cs-gpios = <&pro_micro 1 GPIO_ACTIVE_HIGH>; };

// Key position definitions for positional hold-tap
// Keyball 44 layout: 6x3 main area + 4 thumbs per side
#define KEYS_L 0 1 2 3 4 5 12 13 14 15 16 17 24 25 26 27 28 29  // Left hand keys
#define KEYS_R 6 7 8 9 10 11 18 19 20 21 22 23 30 31 32 33 34 35  // Right hand keys
#define THUMBS 36 37 38 39 40 41 42 43  // All thumb keys

// Timing configuration for layer-tap
&lt {
    tapping-term-ms = <LT_TAPPING_TERM>;
    flavor = "balanced";
    quick-tap-ms = <LT_QUICK_TAP>;
};

&caps_word { continue-list = <UNDERSCORE MINUS>; };

/ {
    behaviors {
        // Timeless homerow mods
        hml: homerow_mods_left { HOMEROW_MOD(KEYS_R THUMBS) }; // left hand
        hmr: homerow_mods_right { HOMEROW_MOD(KEYS_L THUMBS) }; // right hand

        // French accented character macros using US International dead keys
        egrv: egrv_macro { ACCENT_MACRO(GRAVE, E) }; // è
        egrv_cap: egrv_cap_macro { ACCENT_MACRO(GRAVE, LS(E)) }; // È
        eacu: eacu_macro { ACCENT_MACRO(SQT, E) }; // é
        eacu_cap: eacu_cap_macro { ACCENT_MACRO(SQT, LS(E)) }; // É
        ecir: ecir_macro { ACCENT_MACRO(EN_CARET, E) }; // ê
        ecir_cap: ecir_cap_macro { ACCENT_MACRO(EN_CARET, LS(E)) }; // Ê
        agrv: agrv_macro { ACCENT_MACRO(GRAVE, A) }; // à
        agrv_cap: agrv_cap_macro { ACCENT_MACRO(GRAVE, LS(A)) }; // À
        
        // Mod-morphs for lowercase/uppercase accented characters
        e_grv: e_grave_morph {
            compatible = "zmk,behavior-mod-morph";
            #binding-cells = <0>;
            bindings = <&egrv>, <&egrv_cap>;  // unshifted: è, shifted: È
            mods = <(MOD_LSFT|MOD_RSFT)>;
        };
        e_acu: e_acute_morph {
            compatible = "zmk,behavior-mod-morph";
            #binding-cells = <0>;
            bindings = <&eacu>, <&eacu_cap>;  // unshifted: é, shifted: É
            mods = <(MOD_LSFT|MOD_RSFT)>;
        };
        e_cir: e_circumflex_morph {
            compatible = "zmk,behavior-mod-morph";
            #binding-cells = <0>;
            bindings = <&ecir>, <&ecir_cap>;  // unshifted: ê, shifted: Ê
            mods = <(MOD_LSFT|MOD_RSFT)>;
        };
        a_grv: a_grave_morph {
            compatible = "zmk,behavior-mod-morph";
            #binding-cells = <0>;
            bindings = <&agrv>, <&agrv_cap>;  // unshifted: à, shifted: À
            mods = <(MOD_LSFT|MOD_RSFT)>;
        };

        // Ç (c-cedilla) - Uses AltGr+comma on US International
        cced: cced_macro {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&macro_press &kp RALT>
                     , <&macro_tap &kp COMMA>
                     , <&macro_release &kp RALT>;
        };

        // Standalone dead keys (dead key + space)
        dgrv: dgrv_macro { ACCENT_MACRO(GRAVE, SPACE) }; // `
        dcir: dcir_macro { ACCENT_MACRO(EN_CARET, SPACE) }; // ^
        dtil: dtil_macro { ACCENT_MACRO(EN_TILDE, SPACE) }; // ~
        dacu: dacu_macro { ACCENT_MACRO(SQT, SPACE) }; // ´
        ddia: ddia_macro { ACCENT_MACRO(EN_DOUBLE_QUOTES, SPACE) }; // ¨

        // TMUX prefix (Ctrl+B)
        tmux: tmux_macro {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings = <&macro_press &kp LCTRL>
                     , <&macro_tap &kp B>
                     , <&macro_release &kp LCTRL>;
        };

        // Hold-tap behaviors for French accents with home row mods
        // Usage: &egrv_hrm LGUI, &ecir_hrm LALT, &eacu_hrm LCTRL
        egrv_hrm: egrv_homerow_mod { ACCENT_HRM(e_grv) }; // è with mod (pass mod key at usage)
        ecir_hrm: ecir_homerow_mod { ACCENT_HRM(e_cir) }; // ê with mod (pass mod key at usage)
        eacu_hrm: eacu_homerow_mod { ACCENT_HRM(e_acu) }; // é with mod (pass mod key at usage)
    };

    // Tri-layer: NUM activates when both NAV and SYM are held
    conditional_layers {
        compatible = "zmk,conditional-layers";
        tri_layer {
            if-layers = <NAV SYM>;
            then-layer = <NUM>;
        };
    };

    keymap {
        compatible = "zmk,keymap";

        // DEF Layer
        default_layer {
            bindings = <
&kp ESC        &kp Q        &kp W          &kp E          &kp R           &kp T                              &kp Y         &kp U           &kp I           &kp O          &kp P          &kp BSPC
&kp TAB        &hml LSFT A  &hml LGUI S    &hml LALT D    &hml LCTRL F    &kp G                              &kp H         &hmr RCTRL J    &hmr RALT K     &hmr RGUI L    &hmr RSFT SEMI &dacu
&mkp LCLK      &kp Z        &kp X          &kp C          &kp V           &kp B                              &kp N         &kp M           &kp COMMA       &kp DOT        &kp FSLH       &kp DEL
                            &none          &none          &kp LSFT        &kp RET      &mo NAV     &mo SYM   &kp SPACE                                                    &tmux         
            >;
        };

        // NAV Layer - French accented characters (left) + Navigation (right)
        nav_layer {
            bindings = <
&trans         &kp LS(EN_APOS) &kp EN_GRAVE     &kp EN_CARET     &kp EN_APOS       &none                              &kp C_AC_HOME &kp PSCRN       &none           &none          &kp C_VOL_UP   &trans
&none          &kp LSFT        &egrv_hrm LGUI 0 &ecir_hrm LALT 0 &eacu_hrm LCTRL 0 &a_grv                             &kp LEFT      &kp DOWN        &kp UP          &kp RIGHT      &kp C_VOL_DN   &none
&mkp MCLK      &tog SCR        &none            &none            &none             &cced                              &kp HOME      &kp PG_DN       &kp PG_UP       &kp END        &kp C_MUTE     &kp C_AL_CALC
                               &bootloader      &none            &trans            &trans       &trans      &trans    &trans                                                       &trans
            >;
        };

        // SYM Layer
        symbol_layer {
            bindings = <
&trans         &kp EXCL     &kp AT         &kp HASH       &kp DLLR        &kp PRCNT                          &dcir         &kp AMPS        &kp STAR        &none          &none          &trans
&none          &none        &hml LGUI LBRC &hml LALT LBKT &hml LCTRL LPAR &kp PLUS                           &kp MINUS     &hmr RCTRL RPAR &hmr RALT RBKT  &hmr RGUI RBRC &none          &none
&none          &none        &dgrv          &kp PIPE       &dtil           &kp EQUAL                          &kp UNDER     &none           &none           &none          &kp BSLH       &none
                            &none          &none          &trans          &trans       &trans      &trans    &trans                                                       &bootloader        
            >;
        };

        // NUM Layer
        num_layer {
            bindings = <
&trans         &kp F9       &kp F10        &kp F11        &kp F12         &none                              &none         &kp N7          &kp N8          &kp N9         &none          &trans
&none          &hml LSFT F5 &hml LGUI F6   &hml LALT F7   &hml LCTRL F8   &none                              &kp MINUS     &hmr RCTRL N4   &hmr RALT N5    &hmr RGUI N6   &hmr RSFT N0   &none
&none          &kp F1       &kp F2         &kp F3         &kp F4          &none                              &none         &kp N1          &kp N2          &kp N3         &none          &none
                            &none          &none          &trans          &trans       &trans      &trans    &trans                                                       &trans        
            >;
        };

        // SCR Layer (5) - Scroll mode for trackball
        // When this layer is active, trackball movement becomes scrolling
        // This mimics QMK's NumLock scroll behavior
        scroll_layer {
            bindings = <
&trans         &trans       &trans       &trans       &trans        &trans                             &trans        &trans        &trans        &trans        &trans         &trans
&trans         &trans       &trans       &trans       &trans        &trans                             &trans        &trans        &trans        &trans        &trans         &trans
&trans         &trans       &trans       &trans       &trans        &trans                             &trans        &trans        &trans        &trans        &trans         &trans
&trans         &trans       &trans       &trans       &trans                                 &trans    &trans                                                  &trans        
            >;
        };
    };
};
