# P0.13 VCC Cutoff Investigation - EP_OFF Not Working

**Date:** 2025-12-20  
**Critical Finding:** VCC pin on nice!nano does NOT drop to 0V when pressing EP_OFF key

---

## Test Performed

**Setup:**
- Keyboard powered on
- Multimeter measuring nice!nano VCC pin (Pro Micro edge)
- EP_OFF key in keymap (rightmost thumb key)

**Action:** Pressed EP_OFF key

**Expected Result:** VCC drops to ~0V (P0.13 load switch opens)

**Actual Result:** VCC voltage stays at ~2.7V ❌

---

## What This Means

The P0.13 ext_power control is **NOT functioning**, despite:
- ✅ CONFIG_ZMK_EXT_POWER=y enabled
- ✅ ext_power.h header included in keymap  
- ✅ &ext_power EP_OFF in keymap binding
- ✅ nice!nano v2 has P0.13 load switch (per documentation)

**Conclusion:** Something is preventing P0.13 from controlling VCC.

---

## Possible Root Causes

### Hypothesis 1: Display Blocking VCC Cutoff

**Theory:** Display is connected to VCC and preventing shutdown

The nice!nano ext_power implementation might:
- Check if display needs power
- Refuse to disable VCC if display is active
- Keep VCC on to prevent display power loss

**Test:** Disable display and retry
```
# CONFIG_ZMK_DISPLAY=y
```

### Hypothesis 2: EP_OFF Key Not Working

**Theory:** Key binding isn't actually triggering ext_power

Possible issues:
- Key on wrong layer
- Binding syntax error
- ext_power behavior not registered

**Test:** Check USB logs for ext_power messages

### Hypothesis 3: P0.13 GPIO Not Toggling

**Theory:** P0.13 pin state isn't changing

Possible causes:
- GPIO conflict (used elsewhere)
- GPIO configuration error
- Hardware issue with nice!nano

**Test:** Measure P0.13 GPIO directly (not VCC output)

### Hypothesis 4: Nice!nano Load Switch Not Present/Different

**Theory:** This specific nice!nano doesn't have functional P0.13 → VCC switch

Possible reasons:
- Different board revision
- Manufacturing variation
- VCC directly from regulator (no switch)

**Test:** Check nice!nano schematic and board version

---

## Investigation Plan

### Step 1: Verify EP_OFF Command is Received

**Enable USB logging:**

File: `keyball44_right.conf`
```
CONFIG_ZMK_USB_LOGGING=y
CONFIG_LOG_MODE_IMMEDIATE=y
CONFIG_ZMK_LOG_LEVEL_DBG=y
```

**Test procedure:**
1. Build and flash
2. Connect USB cable
3. Open serial monitor: `cat /dev/ttyACM0`
4. Press EP_OFF key
5. Look for log message:
   ```
   [timestamp] <inf> ext_power: disabling external power
   ```

**Results:**
- If message appears: EP_OFF key IS working, problem is GPIO/hardware
- If no message: EP_OFF key NOT working, problem is software/binding

### Step 2: Test with Display Disabled

**Disable display temporarily:**

File: `keyball44_right.conf`
```
# CONFIG_ZMK_DISPLAY=y  # Temporarily disable
CONFIG_ZMK_EXT_POWER=y  # Keep enabled
```

**Test procedure:**
1. Build and flash
2. Power on keyboard (no display activity)
3. Measure VCC pin voltage: Should be ~3.3V
4. Press EP_OFF key
5. Measure VCC pin again

**Expected results:**
- If VCC drops to 0V: Display was blocking ext_power ✅
- If VCC stays high: Display not the issue ❌

### Step 3: Measure P0.13 GPIO State Directly

**Find P0.13 on nice!nano:**
- Check nice!nano schematic
- Identify physical P0.13 pin/pad
- May require tracing from nRF52840

**Test procedure:**
1. Power on keyboard
2. Measure voltage at P0.13 pin: Should be HIGH (3.3V)
3. Press EP_OFF key
4. Measure P0.13 again

**Results interpretation:**
- P0.13 goes LOW (0V): GPIO working, load switch issue ✅
- P0.13 stays HIGH: GPIO not toggling, software issue ❌

### Step 4: Check Alternative ext_power Methods

Try manual ext_power control via code instead of keymap:

Create test that calls ext_power API directly at boot:
```c
#include <drivers/ext_power.h>

// At init
const struct device *ext_power = DEVICE_DT_GET(DT_NODELABEL(EXT_POWER));
ext_power_disable(ext_power);  // Force off at boot
```

If this works → keymap binding issue
If this doesn't work → deeper ext_power problem

---

## Data Collection

### Configuration Status

**Current config (keyball44_right.conf):**
- CONFIG_ZMK_EXT_POWER=y ✅
- CONFIG_ZMK_DISPLAY=y ✅
- CONFIG_PM_DEVICE=y ✅

**Keymap binding:**
```
Line 24: &ext_power EP_OFF
```

**Includes:**
```
Line 6: #include <dt-bindings/zmk/ext_power.h>
```

### Hardware Info Needed

Please provide:
1. **Nice!nano version:** (check board silkscreen - v2.0? v2.1?)
2. **When pressing EP_OFF:**
   - Does display turn off?
   - Does trackball stop working?
   - Any visible change at all?
3. **Which VCC pin measured:**
   - Pin number on Pro Micro edge?
   - Photo if possible?

---

## Quick Diagnostic Questions

**Answer these to narrow down the issue:**

1. **Does EP_OFF do ANYTHING visible?**
   - [ ] Display turns off
   - [ ] Trackball stops
   - [ ] No visible change at all

2. **Do you have USB cable available?**
   - [ ] Yes, can check logs
   - [ ] No USB cable

3. **Nice!nano board version?**
   - [ ] v2.0
   - [ ] v2.1
   - [ ] Unknown (can check)

4. **Willing to test with display disabled?**
   - [ ] Yes
   - [ ] No, need display

---

## Status: INVESTIGATION IN PROGRESS

**Current blocker:** P0.13 ext_power control not functioning

**Hypothesis priority:**
1. Display blocking VCC cutoff (most likely)
2. EP_OFF key binding not working
3. P0.13 GPIO configuration issue
4. Nice!nano hardware variant without load switch

**Next action:** Enable USB logging and test EP_OFF command reception

---

## References

- [Nice!nano v2 Documentation](https://nicekeyboards.com/docs/nice-nano/)
- [ZMK ext_power Behavior](https://zmk.dev/docs/behaviors/power)
- [HARDWARE_VCC_CUTOFF_SOLUTION.md](./HARDWARE_VCC_CUTOFF_SOLUTION.md) - Original P0.13 implementation plan
